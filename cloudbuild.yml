steps:
  # Build Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args: ['build', '-t', '${_ARTIFACT_URL}/${_PROJECT_ID}/${_FOLDER_NAME}/${_SERVICE_NAME}:$SHORT_SHA', '--file=./Dockerfile', '.']

  # Tag Image as Latest
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image-with-latest'
    args: ['tag', '${_ARTIFACT_URL}/${_PROJECT_ID}/${_FOLDER_NAME}/${_SERVICE_NAME}:$SHORT_SHA', '${_ARTIFACT_URL}/${_PROJECT_ID}/${_FOLDER_NAME}/${_SERVICE_NAME}:latest']

  # Push Image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-to-artifact-registry'
    args: ['push', '${_ARTIFACT_URL}/${_PROJECT_ID}/${_FOLDER_NAME}/${_SERVICE_NAME}:latest']

  # Cloud Deploy
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
    - '-c'
    - > 
      gcloud deploy releases create release-$BUILD_ID
      --delivery-pipeline=${_DELIVERY_PIPELINE_NAME}
      --region=${REGION}
      --source=./
      --images=${_ARTIFACT_URL}/${_PROJECT_ID}/${_FOLDER_NAME}/${_SERVICE_NAME}:latest

substitutions:
  _SERVICE_NAME: sharefolio-ui
  _PROJECT_ID: sharefolio-359221
  _FOLDER_NAME: sharefolio-ui-repo
  _ARTIFACT_URL: northamerica-northeast1-docker.pkg.dev
  _REGION: northamerica-northeast1
  _DELIVERY_PIPELINE_NAME: sharefolio
